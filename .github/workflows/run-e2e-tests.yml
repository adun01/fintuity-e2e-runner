name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - preprod
      spec:
        description: 'Test spec (optional, leave empty to run all tests)'
        required: false
        type: string

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Send Telegram notification - Tests started
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üöÄ <b>E2E —Ç–µ—Å—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã</b>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0AURL: <code>${{ secrets.DEV_URL }}</code>" \
            -d "parse_mode=HTML"

      - name: Clone repository from Bitbucket
        run: |
          git clone --depth 1 https://${{ secrets.BITBUCKET_USERNAME }}:${{ secrets.BITBUCKET_API_TOKEN }}@bitbucket.org/fintuity-team/e2e-tests.git project
          cd project
          git log -1 --oneline

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'
          cache-dependency-path: project/package-lock.json

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('project/package-lock.json') }}
          restore-keys: |
            cypress-${{ runner.os }}-

      - name: Install dependencies
        working-directory: project
        run: npm ci

      - name: Run E2E tests
        id: tests
        continue-on-error: true
        working-directory: project
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          CYPRESS_BASE_URL: ${{ secrets.DEV_URL }}
        run: |
          if [ -n "${{ inputs.spec }}" ]; then
            npm run e2e:portal:${{ inputs.environment || 'dev' }} -- --headless --spec "${{ inputs.spec }}"
          else
            npm run e2e:portal:${{ inputs.environment || 'dev' }} -- --headless
          fi

      - name: Upload screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ inputs.environment }}-${{ github.run_number }}
          path: project/screenshots/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: videos-${{ inputs.environment }}-${{ github.run_number }}
          path: project/videos/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload failed requests logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: failed-requests-${{ inputs.environment }}-${{ github.run_number }}
          path: project/failed-requests-logs/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload memory logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memory-logs-${{ inputs.environment }}-${{ github.run_number }}
          path: project/portal-e2e/cypress/results/
          if-no-files-found: ignore
          retention-days: 7

      - name: Send Telegram notification - Tests passed
        if: steps.tests.outcome == 'success'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=‚úÖ <b>–¢–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!</b>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>" \
            -d "parse_mode=HTML"

      - name: Send Telegram notification - Tests failed
        if: steps.tests.outcome == 'failure'
        run: |
          # –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º —É–ø–∞–≤—à–∏–µ —Ç–µ—Å—Ç—ã –ø–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞–º
          TOTAL_FAILED=$(find project/screenshots -type f -name "*.png" 2>/dev/null | wc -l)
          
          if [ "$TOTAL_FAILED" -eq 0 ]; then
            MESSAGE="‚ùå <b>–¢–µ—Å—Ç—ã —É–ø–∞–ª–∏!</b>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0A%0A–ù–µ—Ç —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤"
          else
            # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —É–ø–∞–≤—à–∏—Ö —Ç–µ—Å—Ç–æ–≤ (–ø–æ –∏–º–µ–Ω–∞–º —Ñ–∞–π–ª–æ–≤)
            FAILED_LIST=$(find project/screenshots -type f -name "*failed*.png" 2>/dev/null | head -10 | xargs -I {} basename {} | sed 's/ -- /\n/g' | sed 's/ (failed)\.png//' | head -10)
          
            MESSAGE="‚ùå <b>–¢–µ—Å—Ç—ã —É–ø–∞–ª–∏!</b>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0A%0A<b>–í—Å–µ–≥–æ —É–ø–∞–ª–æ:</b> <code>$TOTAL_FAILED</code> —Ç–µ—Å—Ç–æ–≤%0A%0A<b>–ü–µ—Ä–≤—ã–µ —É–ø–∞–≤—à–∏–µ:</b>%0A<code>$FAILED_LIST</code>%0A%0Aüì∏ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–µ 5 —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤"
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=HTML"

      - name: Send screenshots to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—ã–µ 5 —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
          SCREENSHOTS=$(find project/screenshots -type f -name "*failed*.png" 2>/dev/null | head -5)
          
          for screenshot in $SCREENSHOTS; do
            TEST_NAME=$(basename "$screenshot" .png | sed 's/ -- / - /g')
          
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
              -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -F "photo=@$screenshot" \
              -F "caption=üì∏ $TEST_NAME"
          
            sleep 1
          done

      - name: Fail workflow if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1