name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - preprod
      spec:
        description: 'Test spec (optional, leave empty to run all tests)'
        required: false
        type: string

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Send Telegram notification - Tests started
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üöÄ <b>E2E —Ç–µ—Å—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã</b>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0AURL: <code>${{ secrets.DEV_URL }}</code>" \
            -d "parse_mode=HTML"

      - name: Clone repository from Bitbucket
        run: |
          git clone --depth 1 https://${{ secrets.BITBUCKET_USERNAME }}:${{ secrets.BITBUCKET_API_TOKEN }}@bitbucket.org/fintuity-team/e2e-tests.git project
          cd project
          git log -1 --oneline

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'
          cache-dependency-path: project/package-lock.json

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('project/package-lock.json') }}
          restore-keys: |
            cypress-${{ runner.os }}-

      - name: Install dependencies
        working-directory: project
        run: npm ci

      - name: Start IMAP Proxy Server
        working-directory: project
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
        run: |
          npm run imap-proxy &
          PROXY_PID=$!
          echo "PROXY_PID=$PROXY_PID" >> $GITHUB_ENV

          # –ñ–¥—ë–º –ø–æ–∫–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è
          echo "‚è≥ Waiting for proxy server..."
          for i in {1..10}; do
            if curl -s http://localhost:3100/health > /dev/null; then
              echo "‚úÖ Proxy server is ready"
              break
            fi
            sleep 1
          done

      - name: Run E2E tests
        id: tests
        continue-on-error: true
        working-directory: project
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          CYPRESS_BASE_URL: ${{ secrets.DEV_URL }}
          IMAP_PROXY_URL: http://localhost:3100
        run: |
          SPEC_ARG=""
          if [ -n "${{ inputs.spec }}" ]; then
            SPEC_ARG="--spec ${{ inputs.spec }}"
          fi

          npm run e2e:portal:${{ inputs.environment || 'dev' }} -- --headless $SPEC_ARG 2>&1 | \
            grep --line-buffered -v -E "CertVerifyProcBuiltin|ERROR: No matching issuer|Certificate i=|OU=Cypress Proxy Server Certificate|cert_verify_proc" | \
            tee cypress-output.log

          exit ${PIPESTATUS[0]}

      - name: Parse test results
        if: always()
        working-directory: project
        run: |
          if [ ! -f "cypress-output.log" ]; then
            echo "ERROR: cypress-output.log not found!"
            exit 1
          fi

          # –û—á–∏—â–∞–µ–º ANSI-–∫–æ–¥—ã (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Ubuntu)
          cat cypress-output.log | sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGKHf]//g" > cypress-clean.log

          # –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–¥–ª—è —Ñ–∞–π–ª–∞)
          FULL_SUMMARY=$(grep -A 1000 "(Run Finished)" cypress-clean.log | tail -n +2)
          echo "$FULL_SUMMARY" > summary-full.txt

          # –ö—Ä–∞—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è
          SUMMARY_SHORT=$(echo "$FULL_SUMMARY" | grep "All specs passed\|of.*failed" | tail -1)
          echo "$SUMMARY_SHORT" > summary-short.txt

          # –°—á–∏—Ç–∞–µ–º —Å–ø–µ–∫–∏
          TOTAL_SPECS=$(echo "$FULL_SUMMARY" | grep -c "‚îÇ ‚úî\|‚îÇ ‚úò" || echo "0")
          echo "$TOTAL_SPECS" > total-specs.txt

          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ (head -n -1 —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Ubuntu)
          if grep -q "1 failing" cypress-clean.log; then
            ERROR_DETAILS=$(grep -A 1000 "1 failing" cypress-clean.log | grep -B 1000 "\[fail-fast\]" | head -n -1)
            echo "$ERROR_DETAILS" > error-details.txt
          else
            echo "" > error-details.txt
          fi

          # –ó–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –æ—á–∏—â–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π
          cp cypress-clean.log cypress-output.log

      - name: Send test results to Telegram
        if: always()
        working-directory: project
        run: |
          SUMMARY_SHORT=$(cat summary-short.txt)
          TOTAL_SPECS=$(cat total-specs.txt)

          if grep -q "All specs passed!" cypress-output.log; then
            STATUS="‚úÖ PASSED"
            HEADER="<b>E2E —Ç–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!</b>"
            MESSAGE="$STATUS $HEADER%0A%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0A%0Aüìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</b>%0A<pre>$SUMMARY_SHORT</pre>%0A%0A–í—Å–µ–≥–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π: <b>$TOTAL_SPECS</b>%0A%0AüìÑ –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤ —Ñ–∞–π–ª–µ –Ω–∏–∂–µ ‚¨áÔ∏è"
          else
            STATUS="‚ùå FAILED"
            HEADER="<b>E2E —Ç–µ—Å—Ç—ã —É–ø–∞–ª–∏!</b>"
            ERROR_DETAILS=$(cat error-details.txt | head -c 3000)  # –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É –¥–ª—è Telegram
            MESSAGE="$STATUS $HEADER%0A%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0A%0Aüìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</b>%0A<pre>$SUMMARY_SHORT</pre>%0A%0A–í—Å–µ–≥–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π: <b>$TOTAL_SPECS</b>%0A%0A‚ùóÔ∏è <b>–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:</b>%0A<pre>$ERROR_DETAILS</pre>%0A%0AüìÑ –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤ —Ñ–∞–π–ª–µ –Ω–∏–∂–µ ‚¨áÔ∏è"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=HTML"

      - name: Send full Cypress log to Telegram
        if: always()
        working-directory: project
        run: |
          
          curl -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
            -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -F "document=@cypress-output.log" \
            -F "caption=üìä Full Cypress log"

      - name: Upload screenshots
        if: steps.tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ inputs.environment }}-${{ github.run_number }}
          path: project/screenshots/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload videos
        if: steps.tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: videos-${{ inputs.environment }}-${{ github.run_number }}
          path: project/videos/
          if-no-files-found: ignore
          retention-days: 7

      - name: Send screenshots to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          # –ò—Å–∫–ª—é—á–∞–µ–º before/after each hook —Å–∫—Ä–∏–Ω—à–æ—Ç—ã
          find project/screenshots -type f -name "*failed*.png" 2>/dev/null | \
            grep -v "before each hook" | \
            grep -v "after each hook" | \
            head -5 | \
            while IFS= read -r screenshot; do
              TEST_NAME=$(basename "$screenshot" .png | sed 's/ -- / - /g' | sed 's/ (failed)//')

              echo "üì∏ Sending: $TEST_NAME"

              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
                -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
                -F "photo=@\"$screenshot\"" \
                -F "caption=üì∏ $TEST_NAME" || echo "‚ö†Ô∏è Failed to send"

              sleep 1
            done

      - name: Send videos to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ spec —Ñ–∞–π–ª–æ–≤ –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–æ–≤
          FAILED_SPECS=$(find project/screenshots -type f -name "*failed*.png" | \
            grep -v "before each hook" | \
            grep -v "after each hook" | \
            sed 's|project/screenshots/||' | \
            xargs -I {} dirname {} | \
            sort -u)

          echo "üìã Failed specs:"
          echo "$FAILED_SPECS"

          # –î–ª—è –∫–∞–∂–¥–æ–≥–æ spec –∏—â–µ–º –≤–∏–¥–µ–æ
          echo "$FAILED_SPECS" | while IFS= read -r spec_path; do
            # spec_path = "booking/initialization-service/goal-id.cy.ts"

            VIDEO="project/videos/${spec_path}.mp4"

            if [ -f "$VIDEO" ]; then
              VIDEO_SIZE=$(stat -c%s "$VIDEO" 2>/dev/null || stat -f%z "$VIDEO" 2>/dev/null)

              if [ "$VIDEO_SIZE" -lt 52428800 ]; then
                FILENAME=$(basename "$VIDEO" .mp4)
                echo "üé• Sending: $FILENAME ($(($VIDEO_SIZE / 1048576))MB)"

                curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendVideo" \
                  -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
                  -F "video=@\"$VIDEO\"" \
                  -F "caption=üé• Failed: $FILENAME"

                sleep 2
              fi
            else
              echo "‚ö†Ô∏è No video found: $VIDEO"
            fi
          done

      - name: Send request logs to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          echo "üìã Sending request logs..."

          find project/requests-logs -type f -name "*.json" 2>/dev/null | while IFS= read -r logfile; do
            FILENAME=$(basename "$logfile")

            echo "üìÑ Sending log: $FILENAME"

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
              -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -F "document=@\"$logfile\"" \
              -F "caption=üìã Request log: $FILENAME" || echo "‚ö†Ô∏è Failed to send log"

            sleep 1
          done

      - name: Fail workflow if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1