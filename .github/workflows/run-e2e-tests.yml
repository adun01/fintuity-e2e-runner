name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - preprod
      spec:
        description: 'Test spec (optional, leave empty to run all tests)'
        required: false
        type: string

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - group: booking-pages
            spec_pattern: "portal-e2e/src/integration/groups/booking-pages/*.cy.ts"
            year_offset: 0
          - group: booking-shared
            spec_pattern: "portal-e2e/src/integration/groups/booking-shared/*.cy.ts"
            year_offset: 1
          - group: booking-service
            spec_pattern: "portal-e2e/src/integration/groups/booking-service/*.cy.ts"
            year_offset: 2
          - group: booking-emails
            spec_pattern: "portal-e2e/src/integration/groups/booking-emails/*.cy.ts"
            year_offset: 3
          - group: auth
            spec_pattern: "portal-e2e/src/integration/groups/auth/**/*.cy.ts"
            year_offset: 4
#          - group: kyc
#            spec_pattern: "portal-e2e/src/integration/groups/kyc/**/*.cy.ts"
#            year_offset: 4

    steps:
      - name: Clone repository from Bitbucket
        run: |
          git clone --depth 1 https://${{ secrets.BITBUCKET_USERNAME }}:${{ secrets.BITBUCKET_API_TOKEN }}@bitbucket.org/fintuity-team/e2e-tests.git project
          cd project
          git log -1 --oneline

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'
          cache-dependency-path: project/package-lock.json

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('project/package-lock.json') }}
          restore-keys: |
            cypress-${{ runner.os }}-

      - name: Install dependencies
        working-directory: project
        run: npm ci

      - name: Start IMAP Proxy Server
        working-directory: project
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          BO_USER_EMAIL: ${{ secrets.BO_USER_EMAIL }}
          BO_USER_PASSWORD: ${{ secrets.BO_USER_PASSWORD }}
        run: |
          npm run imap-proxy &
          PROXY_PID=$!
          echo "PROXY_PID=$PROXY_PID" >> $GITHUB_ENV

          echo "â³ Waiting for proxy server..."
          for i in {1..10}; do
            if curl -s http://localhost:3100/health > /dev/null; then
              echo "âœ… Proxy server is ready"
              break
            fi
            sleep 1
          done

      - name: Run E2E tests
        id: tests
        continue-on-error: true
        working-directory: project
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          BO_USER_EMAIL: ${{ secrets.BO_USER_EMAIL }}
          BO_USER_PASSWORD: ${{ secrets.BO_USER_PASSWORD }}
          CYPRESS_BASE_URL: ${{ secrets.DEV_URL }}
          IMAP_PROXY_URL: http://localhost:3100
        run: |
          SPEC_ARG=""
          if [ -n "${{ inputs.spec }}" ]; then
            SPEC_ARG="--spec ${{ inputs.spec }}"
          else
            SPEC_ARG="--spec ${{ matrix.spec_pattern }}"
          fi

          npm run e2e:portal:${{ inputs.environment || 'dev' }} -- --headless $SPEC_ARG --env "groupName=${{ matrix.group }},yearOffset=${{ matrix.year_offset }}" 2>&1 | \
            grep --line-buffered -v -E "CertVerifyProcBuiltin|ERROR: No matching issuer|Certificate i=|OU=Cypress Proxy Server Certificate|cert_verify_proc" | \
            tee cypress-output.log

          exit ${PIPESTATUS[0]}

      - name: Stop IMAP Proxy Server
        if: always()
        run: |
          if [ -n "${{ env.PROXY_PID }}" ]; then
            echo "ðŸ›‘ Stopping proxy server..."
            curl -s -X POST http://localhost:3100/close || true
            kill ${{ env.PROXY_PID }} || true
          fi

      - name: Parse test results
        if: always()
        working-directory: project
        run: |
          if [ ! -f "cypress-output.log" ]; then
            echo "ERROR: cypress-output.log not found!"
            exit 1
          fi

          cat cypress-output.log | sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGKHf]//g" > cypress-clean.log

          FULL_SUMMARY=$(grep -A 1000 "(Run Finished)" cypress-clean.log | tail -n +2)
          echo "$FULL_SUMMARY" > summary-full.txt

          SUMMARY_SHORT=$(echo "$FULL_SUMMARY" | grep "All specs passed\|of.*failed" | tail -1)
          echo "$SUMMARY_SHORT" > summary-short.txt

          TOTAL_SPECS=$(echo "$FULL_SUMMARY" | grep -c "â”‚ âœ”\|â”‚ âœ˜" || echo "0")
          echo "$TOTAL_SPECS" > total-specs.txt

          if grep -q "1 failing" cypress-clean.log; then
            ERROR_DETAILS=$(grep -A 1000 "1 failing" cypress-clean.log | grep -B 1000 "\[fail-fast\]" | head -n -1)
            echo "$ERROR_DETAILS" > error-details.txt
          else
            echo "" > error-details.txt
          fi

          cp cypress-clean.log cypress-output.log

      - name: Send results to Telegram
        if: always()
        working-directory: project
        run: |
          SUMMARY_SHORT=$(cat summary-short.txt)
          TOTAL_SPECS=$(cat total-specs.txt)

          if grep -q "All specs passed!" cypress-output.log; then
            STATUS="âœ… PASSED"
            TARGET_TOPIC_ID="${{ secrets.TELEGRAM_TOPIC_SUCCESS_ID }}"
            HEADER="â”€â”€â”€â”€â”€â”€â”€â”€ Run #${{ github.run_number }} (${{
              inputs.environment || 'dev'
            }}) / group: ${{ matrix.group }} â”€â”€â”€â”€â”€â”€â”€â”€"
            TEXT="$HEADER%0A%0AðŸš€ <b>Ð“Ñ€ÑƒÐ¿Ð¿Ð° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°</b>%0AÐ“Ñ€ÑƒÐ¿Ð¿Ð°: <code>${{ matrix.group }}</code>%0AÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ: <code>${{ inputs.environment || 'dev' }}</code>%0A%0A$STATUS <b>ÐŸÑ€Ð¾ÑˆÐ»Ð°!</b>%0A%0AðŸ“Š <b>Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:</b>%0A<pre>$SUMMARY_SHORT</pre>%0AÐ¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¹: <b>$TOTAL_SPECS</b>"
          else
            STATUS="âŒ FAILED"
            TARGET_TOPIC_ID="${{ secrets.TELEGRAM_TOPIC_FAILED_ID }}"
            HEADER="â”€â”€â”€â”€â”€â”€â”€â”€ Run #${{ github.run_number }} (${{
              inputs.environment || 'dev'
            }}) / group: ${{ matrix.group }} â”€â”€â”€â”€â”€â”€â”€â”€"
            TOTAL_FAILED=$(find screenshots -name "*failed*.png" 2>/dev/null | wc -l || echo "0")
            TEXT="$HEADER%0A%0AðŸš€ <b>Ð“Ñ€ÑƒÐ¿Ð¿Ð° Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½Ð°</b>%0AÐ“Ñ€ÑƒÐ¿Ð¿Ð°: <code>${{ matrix.group }}</code>%0AÐžÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ðµ: <code>${{ inputs.environment || 'dev' }}</code>%0A%0A$STATUS <b>Ð£Ð¿Ð°Ð»Ð°!</b>%0A%0AðŸ“Š <b>Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹:</b>%0A<pre>$SUMMARY_SHORT</pre>%0AÐ¡Ð¿ÐµÑ†Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¹: <b>$TOTAL_SPECS</b>%0AÐ£Ð¿Ð°Ð»Ð¾: <b>$TOTAL_FAILED</b>%0A%0AðŸ“¸ Ð¤Ð°Ð¹Ð»Ñ‹ Ð½Ð¸Ð¶Ðµ â¬‡ï¸"
          fi

          RESPONSE=$(curl -s -X POST 'https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage' \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "message_thread_id=$TARGET_TOPIC_ID" \
            -d "text=$TEXT" \
            -d "parse_mode=HTML")

          MESSAGE_ID=$(echo "$RESPONSE" | jq -r '.result.message_id')
          echo "MESSAGE_ID=$MESSAGE_ID" >> $GITHUB_ENV

      - name: Send full Cypress log to Telegram
        if: steps.tests.outcome == 'failure'
        working-directory: project
        run: |
          curl -s -X POST 'https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument' \
            -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -F "message_thread_id=${{ secrets.TELEGRAM_TOPIC_FAILED_ID }}" \
            -F "document=@cypress-output.log" \
            -F "caption=ðŸ“Š [${{ matrix.group }}] Full Cypress log"

      - name: Upload test artifacts
        if: steps.tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.group }}-${{ inputs.environment }}-${{ github.run_number }}
          path: |
            project/videos/
            project/screenshots/
            project/portal-e2e/requests-logs/
            project/cypress-output.log
            project/summary-full.txt
            project/error-details.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Send screenshots to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          find project/screenshots -type f -name "*failed*.png" 2>/dev/null | \
            grep -v "before each hook" | \
            grep -v "after each hook" | \
            head -5 | \
            while IFS= read -r screenshot; do
              TEST_NAME=$(basename "$screenshot" .png | sed 's/ -- / - /g' | sed 's/ (failed)//')

              echo "ðŸ“¸ Sending: $TEST_NAME"

              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
                -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
                -F "message_thread_id=${{ secrets.TELEGRAM_TOPIC_FAILED_ID }}" \
                -F "photo=@\"$screenshot\"" \
                -F "caption=ðŸ“¸ [${{ matrix.group }}] $TEST_NAME" || echo "âš ï¸ Failed to send"

              sleep 1
            done

      - name: Send videos for failed tests
        if: steps.tests.outcome == 'failure'
        working-directory: project
        run: |
          FAILED_SPECS=$(find screenshots -type f -name "*failed*.png" | \
            grep -v "before each hook" | \
            grep -v "after each hook" | \
            sed 's|screenshots/||' | \
            xargs -I {} dirname {} | \
            sort -u)

          echo "ðŸ“‹ Failed spec files detected:"
          echo "$FAILED_SPECS"

          if [ -z "$FAILED_SPECS" ]; then
            echo "No failed specs found"
            exit 0
          fi

          echo "$FAILED_SPECS" | while read -r spec_path; do
            VIDEO_FILE="videos/${spec_path}.mp4"

            if [ ! -f "$VIDEO_FILE" ]; then
              continue
            fi

            VIDEO_SIZE=$(stat -c%s "$VIDEO_FILE" 2>/dev/null || stat -f%z "$VIDEO_FILE" 2>/dev/null || echo 0)

            if [ "$VIDEO_SIZE" -eq 0 ] || [ "$VIDEO_SIZE" -ge 52428800 ]; then
              continue
            fi

            FILENAME=$(basename "$VIDEO_FILE")
            echo "ðŸ“¤ Sending: $FILENAME"

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendVideo" \
              -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -F "message_thread_id=${{ secrets.TELEGRAM_TOPIC_FAILED_ID }}" \
              -F "video=@$VIDEO_FILE" \
              -F "caption=ðŸŽ¥ [${{ matrix.group }}] $FILENAME"

            sleep 2
          done

      - name: Send request logs to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          find project/portal-e2e/requests-logs -type f -name "*.json" 2>/dev/null | while IFS= read -r logfile; do
            FILENAME=$(basename "$logfile")

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
              -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -F "message_thread_id=${{ secrets.TELEGRAM_TOPIC_FAILED_ID }}" \
              -F "document=@\"$logfile\"" \
              -F "caption=ðŸ“‹ [${{ matrix.group }}] $FILENAME"

            sleep 1
          done

      - name: Fail workflow if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1
