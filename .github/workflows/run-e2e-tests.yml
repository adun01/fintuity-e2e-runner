name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - preprod
      spec:
        description: 'Test spec (optional, leave empty to run all tests)'
        required: false
        type: string

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Send Telegram notification - Tests started
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üöÄ <b>E2E —Ç–µ—Å—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã</b>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0AURL: <code>${{ secrets.DEV_URL }}</code>" \
            -d "parse_mode=HTML"

      - name: Clone repository from Bitbucket
        run: |
          git clone --depth 1 https://${{ secrets.BITBUCKET_USERNAME }}:${{ secrets.BITBUCKET_API_TOKEN }}@bitbucket.org/fintuity-team/e2e-tests.git project
          cd project
          git log -1 --oneline

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'
          cache-dependency-path: project/package-lock.json

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('project/package-lock.json') }}
          restore-keys: |
            cypress-${{ runner.os }}-

      - name: Install dependencies
        working-directory: project
        run: npm ci

      - name: Run E2E tests
        id: tests
        continue-on-error: true
        working-directory: project
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          CYPRESS_BASE_URL: ${{ secrets.DEV_URL }}
        run: |
          SPEC_ARG=""
          if [ -n "${{ inputs.spec }}" ]; then
            SPEC_ARG="--spec ${{ inputs.spec }}"
          fi

          npm run e2e:portal:${{ inputs.environment || 'dev' }} -- --headless $SPEC_ARG 2>&1 | \
            grep --line-buffered -v "CertVerifyProcBuiltin\|ERROR: No matching issuer\|Certificate i=\|OU=Cypress Proxy Server Certificate"

          exit ${PIPESTATUS[0]}

      - name: Upload screenshots
        if: steps.tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-${{ inputs.environment }}-${{ github.run_number }}
          path: project/screenshots/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload videos
        if: steps.tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: videos-${{ inputs.environment }}-${{ github.run_number }}
          path: project/videos/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload requests logs
        if: steps.tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: requests-logs-${{ inputs.environment }}-${{ github.run_number }}
          path: project/requests-logs/
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload memory logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: memory-logs-${{ inputs.environment }}-${{ github.run_number }}
          path: project/portal-e2e/cypress/results/
          if-no-files-found: ignore
          retention-days: 7

      - name: Send Telegram notification - Tests passed
        if: steps.tests.outcome == 'success'
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=‚úÖ <b>–¢–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!</b>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0A%0Aüìä –û—Ç–ø—Ä–∞–≤–ª—è–µ–º Cypress –ª–æ–≥–∏" \
            -d "parse_mode=HTML"

      - name: Send Telegram notification - Tests failed
        if: steps.tests.outcome == 'failure'
        run: |
          # –ë–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π —Å–∫—Ä–∏–Ω—à–æ—Ç –∏ –∏–∑–≤–ª–µ–∫–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–µ—Å—Ç–∞
          FIRST_SCREENSHOT=$(find project/screenshots -type f -name "*failed*.png" 2>/dev/null | head -1)

          if [ -z "$FIRST_SCREENSHOT" ]; then
            TEST_NAME="–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–µ—Å—Ç"
          else
            TEST_NAME=$(basename "$FIRST_SCREENSHOT" | sed 's/ -- .*//' | sed 's/ (failed)\.png$//')
          fi

          MESSAGE="‚ùå <b>–¢–µ—Å—Ç —É–ø–∞–ª!</b>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0A%0A<b>–¢–µ—Å—Ç:</b> <code>$TEST_NAME</code>%0A%0Aüì∏ –°–∫—Ä–∏–Ω—à–æ—Ç—ã%0Aüé• –í–∏–¥–µ–æ%0Aüìã –õ–æ–≥–∏%0Aüìä Cypress –ª–æ–≥–∏"

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=$MESSAGE" \
            -d "parse_mode=HTML"

      - name: Send screenshots to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          # –ò—Å–∫–ª—é—á–∞–µ–º before/after each hook —Å–∫—Ä–∏–Ω—à–æ—Ç—ã
          find project/screenshots -type f -name "*failed*.png" 2>/dev/null | \
            grep -v "before each hook" | \
            grep -v "after each hook" | \
            head -5 | \
            while IFS= read -r screenshot; do
              TEST_NAME=$(basename "$screenshot" .png | sed 's/ -- / - /g' | sed 's/ (failed)//')

              echo "üì∏ Sending: $TEST_NAME"

              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
                -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
                -F "photo=@\"$screenshot\"" \
                -F "caption=üì∏ $TEST_NAME" || echo "‚ö†Ô∏è Failed to send"

              sleep 1
            done

      - name: Send videos to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          echo "üé• Sending video for failed test..."

          # –ü–æ–ª—É—á–∞–µ–º –∏–º—è —É–ø–∞–≤—à–µ–≥–æ —Ç–µ—Å—Ç–∞ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
          FIRST_SCREENSHOT=$(find project/screenshots -type f -name "*failed*.png" 2>/dev/null | \
            grep -v "before each hook" | \
            grep -v "after each hook" | \
            head -1)

          if [ -z "$FIRST_SCREENSHOT" ]; then
            echo "‚ö†Ô∏è No failed test screenshots found"
            exit 0
          fi

          # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–º—è —Ç–µ—Å—Ç–∞ –∏–∑ —Å–∫—Ä–∏–Ω—à–æ—Ç–∞
          # –ü—Ä–∏–º–µ—Ä: "Booking close btn test -- ... (failed).png"
          # –ë–µ—Ä—ë–º –≤—Å—ë –¥–æ " -- "
          TEST_NAME=$(basename "$FIRST_SCREENSHOT" | sed 's/ -- .*//')
          echo "Failed test: $TEST_NAME"

          # –ò—â–µ–º –≤–∏–¥–µ–æ –ø–æ –ø–∞—Ç—Ç–µ—Ä–Ω—É –∏–º–µ–Ω–∏
          # –°–∫—Ä–∏–Ω—à–æ—Ç: "Booking close btn test"
          # –í–∏–¥–µ–æ: "booking-close-btn-test.cy.ts.mp4"
          # –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º: –ø—Ä–æ–±–µ–ª—ã ‚Üí –¥–µ—Ñ–∏—Å—ã, –º–∞–ª–µ–Ω—å–∫–∏–µ –±—É–∫–≤—ã
          VIDEO_PATTERN=$(echo "$TEST_NAME" | tr '[:upper:]' '[:lower:]' | tr ' ' '-')
          echo "Looking for video with pattern: $VIDEO_PATTERN"

          # –ò—â–µ–º –≤–∏–¥–µ–æ
          VIDEO=$(find project/videos -type f -name "${VIDEO_PATTERN}*.mp4" 2>/dev/null | head -1)

          if [ -z "$VIDEO" ]; then
            echo "‚ö†Ô∏è No video found for failed test"
            exit 0
          fi

          VIDEO_SIZE=$(stat -c%s "$VIDEO" 2>/dev/null || stat -f%z "$VIDEO" 2>/dev/null)
          FILENAME=$(basename "$VIDEO" .mp4)

          # Telegram –ª–∏–º–∏—Ç 50MB
          if [ "$VIDEO_SIZE" -lt 52428800 ]; then
            echo "üé• Sending video: $FILENAME ($(($VIDEO_SIZE / 1048576))MB)"

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendVideo" \
              -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -F "video=@\"$VIDEO\"" \
              -F "caption=üé• $FILENAME" || echo "‚ö†Ô∏è Failed to send video"
          else
            echo "‚ö†Ô∏è Video too large: $FILENAME ($(($VIDEO_SIZE / 1048576))MB)"
          fi

      - name: Send request logs to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          echo "üìã Sending request logs..."

          find project/requests-logs -type f -name "*.json" 2>/dev/null | while IFS= read -r logfile; do
            FILENAME=$(basename "$logfile")

            echo "üìÑ Sending log: $FILENAME"

            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
              -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -F "document=@\"$logfile\"" \
              -F "caption=üìã Request log: $FILENAME" || echo "‚ö†Ô∏è Failed to send log"

            sleep 1
          done

      - name: Send Cypress logs to Telegram
        if: always()
        run: |
          echo "üìÑ Sending Cypress logs..."

          if [ -d "project/portal-e2e/cypress/results" ]; then
            find project/portal-e2e/cypress/results -type f \( -name "*.json" -o -name "*.log" -o -name "*.txt" \) 2>/dev/null | while IFS= read -r logfile; do
              FILENAME=$(basename "$logfile")

              echo "üìä Sending: $FILENAME"

              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
                -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
                -F "document=@\"$logfile\"" \
                -F "caption=üìä Cypress log: $FILENAME" || echo "‚ö†Ô∏è Failed to send"

              sleep 1
            done
          fi

          if [ -d "project/portal-e2e/cypress/logs" ]; then
            find project/portal-e2e/cypress/logs -type f 2>/dev/null | while IFS= read -r logfile; do
              FILENAME=$(basename "$logfile")

              echo "üìù Sending: $FILENAME"

              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
                -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
                -F "document=@\"$logfile\"" \
                -F "caption=üìù Log: $FILENAME" || echo "‚ö†Ô∏è Failed to send"

              sleep 1
            done
          fi

      - name: Fail workflow if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1