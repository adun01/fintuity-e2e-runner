name: E2E Tests

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test environment'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
          - preprod
      spec:
        description: 'Test spec (optional, leave empty to run all tests)'
        required: false
        type: string

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          - group: booking-pages
            spec_pattern: "portal-e2e/src/integration/groups/booking-pages/*.cy.ts"
            year_offset: 0
          - group: booking-shared
            spec_pattern: "portal-e2e/src/integration/groups/booking-shared/*.cy.ts"
            year_offset: 1
          - group: booking-initialization
            spec_pattern: "portal-e2e/src/integration/groups/booking-initialization-service/*.cy.ts"
            year_offset: 2
          - group: auth
            spec_pattern: "portal-e2e/src/integration/groups/auth/**/*.cy.ts"
            year_offset: 3

    steps:
      - name: Send Telegram notification - Tests started
        id: telegram_start
        run: |
          RESPONSE=$(curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "text=üöÄ <b>E2E —Ç–µ—Å—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã</b>%0A–ì—Ä—É–ø–ø–∞: <code>${{ matrix.group }}</code>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0AURL: <code>${{ secrets.DEV_URL }}</code>" \
            -d "parse_mode=HTML")
          
          MESSAGE_ID=$(echo "$RESPONSE" | jq -r '.result.message_id')
          echo "MESSAGE_ID=$MESSAGE_ID" >> $GITHUB_ENV
          echo "üì® Message ID: $MESSAGE_ID"

      - name: Clone repository from Bitbucket
        run: |
          git clone --depth 1 https://${{ secrets.BITBUCKET_USERNAME }}:${{ secrets.BITBUCKET_API_TOKEN }}@bitbucket.org/fintuity-team/e2e-tests.git project
          cd project
          git log -1 --oneline

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.18.1'
          cache: 'npm'
          cache-dependency-path: project/package-lock.json

      - name: Cache Cypress binary
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('project/package-lock.json') }}
          restore-keys: |
            cypress-${{ runner.os }}-

      - name: Install dependencies
        working-directory: project
        run: npm ci

      - name: Start IMAP Proxy Server
        working-directory: project
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
        run: |
          npm run imap-proxy &
          PROXY_PID=$!
          echo "PROXY_PID=$PROXY_PID" >> $GITHUB_ENV

          # –ñ–¥—ë–º –ø–æ–∫–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ–¥–Ω–∏–º–µ—Ç—Å—è
          echo "‚è≥ Waiting for proxy server..."
          for i in {1..10}; do
            if curl -s http://localhost:3100/health > /dev/null; then
              echo "‚úÖ Proxy server is ready"
              break
            fi
            sleep 1
          done

      - name: Run E2E tests
        id: tests
        continue-on-error: true
        working-directory: project
        env:
          GMAIL_USER: ${{ secrets.GMAIL_USER }}
          GMAIL_PASSWORD: ${{ secrets.GMAIL_PASSWORD }}
          CYPRESS_BASE_URL: ${{ secrets.DEV_URL }}
          IMAP_PROXY_URL: http://localhost:3100
        run: |
          SPEC_ARG=""
          if [ -n "${{ inputs.spec }}" ]; then
            SPEC_ARG="--spec ${{ inputs.spec }}"
          else
            SPEC_ARG="--spec ${{ matrix.spec_pattern }}"
          fi

          npm run e2e:portal:${{ inputs.environment || 'dev' }} -- --headless $SPEC_ARG --env "groupName=${{ matrix.group }},yearOffset=${{ matrix.year_offset }}" 2>&1 | \
            grep --line-buffered -v -E "CertVerifyProcBuiltin|ERROR: No matching issuer|Certificate i=|OU=Cypress Proxy Server Certificate|cert_verify_proc" | \
            tee cypress-output.log

          exit ${PIPESTATUS[0]}
#      - name: MEGA DEBUG - Find requests-logs everywhere
#        if: always()
#        run: |
#          echo "=========================================="
#          echo "üîç SEARCHING FOR requests-logs EVERYWHERE"
#          echo "=========================================="
#
#          echo ""
#          echo "üìÇ Current directory:"
#          pwd
#
#          echo ""
#          echo "üìÇ Directory structure:"
#          ls -la
#
#          echo ""
#          echo "üîç Find ALL requests-logs directories:"
#          find / -name "requests-logs" -type d 2>/dev/null || echo "Not found in root"
#
#          echo ""
#          echo "üîç Find in /home/runner:"
#          find /home/runner -name "requests-logs" -type d 2>/dev/null || echo "Not found in /home/runner"
#
#          echo ""
#          echo "üîç Find in current workspace:"
#          find . -name "requests-logs" -type d 2>/dev/null || echo "Not found in workspace"
#
#          echo ""
#          echo "üìã Find ALL .json files with 'request' in path:"
#          find . -type f -name "*.json" -path "*request*" 2>/dev/null || echo "No request JSONs found"
#
#          echo ""
#          echo "üìÇ Project directory contents:"
#          ls -la project/ || echo "project/ not found"
#
#          echo ""
#          echo "üìÇ portal-e2e directory contents:"
#          ls -la project/portal-e2e/ || echo "portal-e2e/ not found"
#
#          echo ""
#          echo "üîç Cypress output log content (last 50 lines):"
#          tail -50 project/cypress-output.log 2>/dev/null || echo "cypress-output.log not found"
#
#          echo ""
#          echo "üîç Search for 'saveAllRequests' in logs:"
#          grep -i "saveAllRequests" project/cypress-output.log 2>/dev/null || echo "No saveAllRequests mentions"
#
#          echo ""
#          echo "üîç Search for 'afterEach called' in logs:"
#          grep -i "afterEach called" project/cypress-output.log 2>/dev/null || echo "No afterEach mentions"
#
#          echo ""
#          echo "üîç Search for 'Test failed' in logs:"
#          grep -i "Test failed" project/cypress-output.log 2>/dev/null || echo "No 'Test failed' mentions"
#
#          echo "=========================================="
      - name: Stop IMAP Proxy Server
        if: always()
        run: |
          if [ -n "${{ env.PROXY_PID }}" ]; then
            echo "üõë Stopping proxy server..."
            curl -s -X POST http://localhost:3100/close || true
            kill ${{ env.PROXY_PID }} || true
          fi

      - name: Parse test results
        if: always()
        working-directory: project
        run: |
          if [ ! -f "cypress-output.log" ]; then
            echo "ERROR: cypress-output.log not found!"
            exit 1
          fi

          # –û—á–∏—â–∞–µ–º ANSI-–∫–æ–¥—ã (—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Ubuntu)
          cat cypress-output.log | sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2})?)?[mGKHf]//g" > cypress-clean.log

          # –ü–æ–ª–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ (–¥–ª—è —Ñ–∞–π–ª–∞)
          FULL_SUMMARY=$(grep -A 1000 "(Run Finished)" cypress-clean.log | tail -n +2)
          echo "$FULL_SUMMARY" > summary-full.txt

          # –ö—Ä–∞—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è
          SUMMARY_SHORT=$(echo "$FULL_SUMMARY" | grep "All specs passed\|of.*failed" | tail -1)
          echo "$SUMMARY_SHORT" > summary-short.txt

          # –°—á–∏—Ç–∞–µ–º —Å–ø–µ–∫–∏
          TOTAL_SPECS=$(echo "$FULL_SUMMARY" | grep -c "‚îÇ ‚úî\|‚îÇ ‚úò" || echo "0")
          echo "$TOTAL_SPECS" > total-specs.txt

          # –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏ (head -n -1 —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ Ubuntu)
          if grep -q "1 failing" cypress-clean.log; then
            ERROR_DETAILS=$(grep -A 1000 "1 failing" cypress-clean.log | grep -B 1000 "\[fail-fast\]" | head -n -1)
            echo "$ERROR_DETAILS" > error-details.txt
          else
            echo "" > error-details.txt
          fi

          # –ó–∞–º–µ–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –æ—á–∏—â–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π
          cp cypress-clean.log cypress-output.log

      - name: Update Telegram message with results
        if: always()
        working-directory: project
        run: |
          SUMMARY_SHORT=$(cat summary-short.txt)
          TOTAL_SPECS=$(cat total-specs.txt)

          if grep -q "All specs passed!" cypress-output.log; then
            STATUS="‚úÖ PASSED"
            TEXT="üöÄ <b>E2E —Ç–µ—Å—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã</b>%0A–ì—Ä—É–ø–ø–∞: <code>${{ matrix.group }}</code>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0AURL: <code>${{ secrets.DEV_URL }}</code>%0A%0A$STATUS <b>–ì—Ä—É–ø–ø–∞ '${{ matrix.group }}' –ø—Ä–æ—à–ª–∞!</b>%0A%0Aüìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</b>%0A<pre>$SUMMARY_SHORT</pre>%0A–í—Å–µ–≥–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π: <b>$TOTAL_SPECS</b>"
          else
            STATUS="‚ùå FAILED"
            TOTAL_FAILED=$(find screenshots -name "*failed*.png" 2>/dev/null | wc -l || echo "0")
            TEXT="üöÄ <b>E2E —Ç–µ—Å—Ç—ã –∑–∞–ø—É—â–µ–Ω—ã</b>%0A–ì—Ä—É–ø–ø–∞: <code>${{ matrix.group }}</code>%0A–û–∫—Ä—É–∂–µ–Ω–∏–µ: <code>${{ inputs.environment || 'dev' }}</code>%0AURL: <code>${{ secrets.DEV_URL }}</code>%0A%0A$STATUS <b>–ì—Ä—É–ø–ø–∞ '${{ matrix.group }}' —É–ø–∞–ª–∞!</b>%0A%0Aüìä <b>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã:</b>%0A<pre>$SUMMARY_SHORT</pre>%0A–í—Å–µ–≥–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–π: <b>$TOTAL_SPECS</b>%0A–£–ø–∞–ª–æ —Ç–µ—Å—Ç–æ–≤: <b>$TOTAL_FAILED</b>%0A%0Aüì∏ –°–∫—Ä–∏–Ω—à–æ—Ç—ã, –≤–∏–¥–µ–æ –∏ –ª–æ–≥–∏ –Ω–∏–∂–µ ‚¨áÔ∏è"
          fi

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/editMessageText" \
            -d "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -d "message_id=${{ env.MESSAGE_ID }}" \
            -d "text=$TEXT" \
            -d "parse_mode=HTML"

      - name: Send full Cypress log to Telegram
        if: always()
        working-directory: project
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
            -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
            -F "reply_to_message_id=${{ env.MESSAGE_ID }}" \
            -F "document=@cypress-output.log" \
            -F "caption=üìä [${{ matrix.group }}] Full Cypress log"

#      - name: Debug - Check request logs
#        if: always()
#        working-directory: project
#        run: |
#          echo "üìÇ Looking for requests-logs directory..."
#          find . -name "requests-logs" -type d 2>/dev/null || echo "Directory not found"
#
#          echo ""
#          echo "üìã Looking for JSON files..."
#          find . -name "*.json" -path "*/requests-logs/*" 2>/dev/null || echo "No JSON files found"
#
#          echo ""
#          echo "üìä Directory tree:"
#          ls -la portal-e2e/requests-logs/ 2>/dev/null || echo "requests-logs doesn't exist"
#
#          echo ""
#          echo "üîç All JSON files in project:"
#          find . -name "*.json" -type f | grep -v node_modules | head -20

      - name: Upload test artifacts
        if: steps.tests.outcome == 'failure'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.group }}-${{ inputs.environment }}-${{ github.run_number }}
          path: |
            project/videos/
            project/screenshots/
            project/portal-e2e/requests-logs/
            project/cypress-output.log
            project/summary-full.txt
            project/error-details.txt
          if-no-files-found: ignore
          retention-days: 7

      - name: Send screenshots to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          find project/screenshots -type f -name "*failed*.png" 2>/dev/null | \
            grep -v "before each hook" | \
            grep -v "after each hook" | \
            head -5 | \
            while IFS= read -r screenshot; do
              TEST_NAME=$(basename "$screenshot" .png | sed 's/ -- / - /g' | sed 's/ (failed)//')
          
              echo "üì∏ Sending: $TEST_NAME"
          
              curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendPhoto" \
                -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
                -F "reply_to_message_id=${{ env.MESSAGE_ID }}" \
                -F "photo=@\"$screenshot\"" \
                -F "caption=üì∏ [${{ matrix.group }}] $TEST_NAME" || echo "‚ö†Ô∏è Failed to send"
          
              sleep 1
            done

      - name: Send videos for failed tests
        if: always()
        working-directory: project
        run: |
          FAILED_SPECS=$(find screenshots -type f -name "*failed*.png" | \
            grep -v "before each hook" | \
            grep -v "after each hook" | \
            sed 's|screenshots/||' | \
            xargs -I {} dirname {} | \
            sort -u)
          
          echo "üìã Failed spec files detected:"
          echo "$FAILED_SPECS"
          
          if [ -z "$FAILED_SPECS" ]; then
            echo "No failed specs found"
            exit 0
          fi
          
          echo "$FAILED_SPECS" | while read -r spec_path; do
            VIDEO_FILE="videos/${spec_path}.mp4"
          
            if [ ! -f "$VIDEO_FILE" ]; then
              continue
            fi
          
            VIDEO_SIZE=$(stat -c%s "$VIDEO_FILE" 2>/dev/null || stat -f%z "$VIDEO_FILE" 2>/dev/null || echo 0)
          
            if [ "$VIDEO_SIZE" -eq 0 ] || [ "$VIDEO_SIZE" -ge 52428800 ]; then
              continue
            fi
          
            FILENAME=$(basename "$VIDEO_FILE")
            echo "üì§ Sending: $FILENAME"
          
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendVideo" \
              -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -F "reply_to_message_id=${{ env.MESSAGE_ID }}" \
              -F "video=@$VIDEO_FILE" \
              -F "caption=üé• [${{ matrix.group }}] $FILENAME"
          
            sleep 2
          done

      - name: Send request logs to Telegram
        if: steps.tests.outcome == 'failure'
        run: |
          find project/portal-e2e/requests-logs -type f -name "*.json" 2>/dev/null | while IFS= read -r logfile; do
            FILENAME=$(basename "$logfile")
          
            curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument" \
              -F "chat_id=${{ secrets.TELEGRAM_CHAT_ID }}" \
              -F "reply_to_message_id=${{ env.MESSAGE_ID }}" \
              -F "document=@\"$logfile\"" \
              -F "caption=üìã [${{ matrix.group }}] $FILENAME"
          
            sleep 1
          done

      - name: Fail workflow if tests failed
        if: steps.tests.outcome == 'failure'
        run: exit 1